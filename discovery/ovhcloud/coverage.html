
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>ovhcloud: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/prometheus/prometheus/discovery/ovhcloud/dedicated_server.go (97.1%)</option>
				
				<option value="file1">github.com/prometheus/prometheus/discovery/ovhcloud/ovhcloud.go (97.8%)</option>
				
				<option value="file2">github.com/prometheus/prometheus/discovery/ovhcloud/vps.go (97.9%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">// Copyright 2021 The Prometheus Authors
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package ovhcloud

import (
        "context"
        "fmt"

        "github.com/fatih/structs"
        "github.com/go-kit/log"
        "github.com/go-kit/log/level"

        "github.com/ovh/go-ovh/ovh"
        "github.com/prometheus/common/model"

        "github.com/prometheus/prometheus/discovery/refresh"
        "github.com/prometheus/prometheus/discovery/targetgroup"
)

const dedicatedServerAPIPath = "/dedicated/server"

//DedicatedServer struct
type DedicatedServer struct {
        ProfessionalUse  bool    `json:"professionalUse"`
        State            string  `json:"state"`
        RescueMail       *string `json:"rescueMail"`
        NewUpgradeSystem bool    `json:"newUpgradeSystem"`
        IP               string  `json:"ip" label:"ipv4"`
        CommercialRange  string  `json:"commercialRange"`
        LinkSpeed        int     `json:"linkSpeed"`
        Rack             string  `json:"rack"`
        NoIntervention   bool    `json:"noIntervention"`
        Os               string  `json:"os"`
        SupportLevel     string  `json:"supportLevel"`
        RootDevice       *string `json:"rootDevice"`
        ServerID         int64   `json:"serverId"`
        BootID           int     `json:"bootId"`
        Reverse          string  `json:"reverse"`
        Datacenter       string  `json:"datacenter"`
        Name             string  `json:"name"`
        Monitoring       bool    `json:"monitoring"`
}

const (
        dedicatedServerLabelPrefix = metaLabelPrefix + "dedicatedServer_"
)

type dedicatedServerDiscovery struct {
        *refresh.Discovery
        config *SDConfig
        logger log.Logger
}

func newDedicatedServerDiscovery(conf *SDConfig, logger log.Logger) *dedicatedServerDiscovery <span class="cov8" title="1">{
        return &amp;dedicatedServerDiscovery{config: conf, logger: logger}
}</span>

func getDedicatedServerList(client *ovh.Client) ([]string, error) <span class="cov8" title="1">{
        var dedicatedListName []string
        err := client.Get(dedicatedServerAPIPath, &amp;dedicatedListName)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return dedicatedListName, nil</span>
}

func getDedicateServerDetails(client *ovh.Client, serverName string) (*DedicatedServer, error) <span class="cov8" title="1">{
        var dedicatedServerDetails DedicatedServer
        err := client.Get(fmt.Sprintf("%s/%s", dedicatedServerAPIPath, serverName), &amp;dedicatedServerDetails)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return &amp;dedicatedServerDetails, nil</span>
}

func (d *dedicatedServerDiscovery) getSource() string <span class="cov8" title="1">{
        return "ovhcloud_dedicated_server"
}</span>

func (d *dedicatedServerDiscovery) refresh(ctx context.Context) ([]*targetgroup.Group, error) <span class="cov8" title="1">{
        client, err := (d.config).CreateClient()
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">var dedicatedServerDetailedList []DedicatedServer
        dedicatedServerList, err := getDedicatedServerList(client)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">for _, dedicatedServerName := range dedicatedServerList </span><span class="cov8" title="1">{
                dedicatedServer, err := getDedicateServerDetails(client, dedicatedServerName)
                if err != nil </span><span class="cov8" title="1">{
                        err := level.Warn(d.logger).Log("msg", fmt.Sprintf("%s: Could not get details of %s", d.getSource(), dedicatedServerName), "err", err.Error())
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov8" title="1">continue</span>
                }
                <span class="cov8" title="1">dedicatedServerDetailedList = append(dedicatedServerDetailedList, *dedicatedServer)</span>
        }
        <span class="cov8" title="1">var targets []model.LabelSet

        for _, server := range dedicatedServerDetailedList </span><span class="cov8" title="1">{
                labels := model.LabelSet{
                        model.AddressLabel:  model.LabelValue(server.IP),
                        model.InstanceLabel: model.LabelValue(server.Name),
                }

                fields := structs.Fields(server)
                addFieldsOnLabels(fields, labels, dedicatedServerLabelPrefix)

                targets = append(targets, labels)
        }</span>

        <span class="cov8" title="1">return []*targetgroup.Group{{Source: d.getSource(), Targets: targets}}, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">// Copyright 2021 The Prometheus Authors
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package ovhcloud

import (
        "context"
        "fmt"
        "time"

        "github.com/fatih/structs"
        "github.com/go-kit/log"
        "github.com/go-kit/log/level"
        "github.com/go-playground/validator/v10"
        "github.com/ovh/go-ovh/ovh"
        "github.com/prometheus/common/model"
        "github.com/prometheus/prometheus/discovery"
        "github.com/prometheus/prometheus/discovery/refresh"
        "github.com/prometheus/prometheus/discovery/targetgroup"
)

// metaLabelPrefix is the meta prefix used for all meta labels.
// in this discovery.
const (
        metaLabelPrefix = model.MetaLabelPrefix + "ovhcloud_"
        separator       = ","
)

func addFieldsOnLabels(fields []*structs.Field, labels model.LabelSet, prefix string) <span class="cov8" title="1">{
        for _, f := range fields </span><span class="cov8" title="1">{
                labelName := f.Tag("label")
                if labelName == "-" </span><span class="cov8" title="1">{
                        // Skip labels with -
                        continue</span>
                }
                <span class="cov8" title="1">if labelName == "" </span><span class="cov8" title="1">{
                        labelName = f.Tag("json")
                }</span>

                <span class="cov8" title="1">if labelName != "" </span><span class="cov8" title="1">{
                        labels[model.LabelName(prefix+labelName)] = model.LabelValue(fmt.Sprintf("%+v", f.Value()))
                }</span>
        }
}

// DefaultSDConfig is the default Ovhcloud Service Discovery configuration.
var DefaultSDConfig = SDConfig{
        RefreshInterval: model.Duration(60 * time.Second),
}

type refresher interface {
        refresh(context.Context) ([]*targetgroup.Group, error)
        getSource() string
}

// OvhCloud type to list refreshers
type OvhCloud struct {
        RefresherList []refresher
        logger        log.Logger
        config        *SDConfig
}

//PartialMe partial
type PartialMe struct {
        Firstname string `json:"firstname"`
}

// SDConfig sd config
type SDConfig struct {
        Endpoint          string          `yaml:"endpoint" validate:"required"`
        ApplicationKey    string          `yaml:"application_key" validate:"required"`
        ApplicationSecret string          `yaml:"application_secret" validate:"required"`
        ConsumerKey       string          `yaml:"consumer_key" validate:"required"`
        RefreshInterval   model.Duration  `yaml:"refresh_interval"`
        SourcesToDisable  []string        `yaml:"sources_to_disable"`
        DisabledSources   map[string]bool `yaml:"-"`
}

//Name get name
func (c SDConfig) Name() string <span class="cov8" title="1">{
        return "ovhcloud"
}</span>

// UnmarshalYAML implements the yaml.Unmarshaler interface.
func (c *SDConfig) UnmarshalYAML(unmarshal func(interface{}) error) error <span class="cov8" title="1">{
        *c = DefaultSDConfig
        type plain SDConfig
        err := unmarshal((*plain)(c))
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">validate := validator.New()

        if err := validate.Struct(c); err != nil </span><span class="cov8" title="1">{
                return fmt.Errorf("failed to validate SDConfig err: %w", err)
        }</span>

        <span class="cov8" title="1">c.DisabledSources = map[string]bool{}
        for _, sourceName := range c.SourcesToDisable </span><span class="cov8" title="1">{
                c.DisabledSources[sourceName] = true
        }</span>

        <span class="cov8" title="1">client, err := c.CreateClient()
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>
        <span class="cov8" title="1">var me PartialMe
        return client.Get("/me", &amp;me)</span>
}

// CreateClient get client
func (c SDConfig) CreateClient() (*ovh.Client, error) <span class="cov8" title="1">{
        return ovh.NewClient(c.Endpoint, c.ApplicationKey, c.ApplicationSecret, c.ConsumerKey)
}</span>

// NewDiscoverer new discoverer
func (c SDConfig) NewDiscoverer(options discovery.DiscovererOptions) (discovery.Discoverer, error) <span class="cov8" title="1">{
        return NewDiscovery(&amp;c, options.Logger), nil
}</span>

func init() <span class="cov8" title="1">{
        discovery.RegisterConfig(&amp;SDConfig{})
}</span>

// NewDiscovery ovhcloud create a newOvhCloudDiscovery and call refresh
func NewDiscovery(conf *SDConfig, logger log.Logger) *refresh.Discovery <span class="cov8" title="1">{

        ovhcloud := newOvhCloudDiscovery(conf, logger)

        return refresh.NewDiscovery(
                logger,
                "ovhcloud",
                time.Duration(conf.RefreshInterval),
                ovhcloud.refresh,
        )
}</span>

func newOvhCloudDiscovery(conf *SDConfig, logger log.Logger) *OvhCloud <span class="cov8" title="1">{
        vpsRefresher := newVpsDiscovery(conf, logger)

        dedicatedCloudRefresher := newDedicatedServerDiscovery(conf, logger)

        ovhC := OvhCloud{config: conf, RefresherList: []refresher{vpsRefresher, dedicatedCloudRefresher}, logger: logger}
        return &amp;ovhC
}</span>

func (c OvhCloud) refresh(ctx context.Context) ([]*targetgroup.Group, error) <span class="cov8" title="1">{
        var groups []*targetgroup.Group
        for _, r := range c.RefresherList </span><span class="cov8" title="1">{
                source := r.getSource()
                isDisabled, ok := c.config.DisabledSources[source]

                if !ok || !isDisabled </span><span class="cov8" title="1">{
                        rGroups, err := r.refresh(ctx)
                        if err != nil </span><span class="cov8" title="1">{
                                err := level.Error(c.logger).Log("msg", fmt.Sprintf("Unable to refresh %s", source), "err", err.Error())
                                if err != nil </span><span class="cov0" title="0">{
                                        return nil, err
                                }</span>
                        }
                        <span class="cov8" title="1">groups = append(groups, rGroups...)</span>
                }
        }

        <span class="cov8" title="1">return groups, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">// Copyright 2021 The Prometheus Authors
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package ovhcloud

import (
        "context"
        "fmt"

        "inet.af/netaddr"

        "github.com/fatih/structs"
        "github.com/go-kit/log"
        "github.com/go-kit/log/level"
        "github.com/ovh/go-ovh/ovh"
        "github.com/prometheus/common/model"
        "github.com/prometheus/prometheus/discovery/refresh"
        "github.com/prometheus/prometheus/discovery/targetgroup"
)

const vpsAPIPath = "/vps"

//Model struct from API
type Model struct {
        MaximumAdditionalIP int      `json:"maximumAdditionnalIp" label:"maximumAdditionalIp"`
        Offer               string   `json:"offer"`
        Datacenter          []string `json:"datacenter"`
        Vcore               int      `json:"vcore"`
        Version             string   `json:"version"`
        Name                string   `json:"name" label:"model_name"`
        Disk                int      `json:"disk"`
        AvailableOptions    []string `json:"availableOptions" label:"-"`
        Memory              int      `json:"memory"`
}

//Vps struct from API
type Vps struct {
        IPV4               string   `label:"ipv4"`
        IPV6               string   `label:"ipv6"`
        Keymap             []string `json:"keymap" label:"-"`
        Zone               string   `json:"zone"`
        Model              Model    `json:"model" label:"-"`
        DisplayName        string   `json:"displayName"`
        MonitoringIPBlocks []string `json:"monitoringIpBlocks" label:"-"`
        Cluster            string   `json:"cluster"`
        State              string   `json:"state"`
        Name               string   `json:"name"`
        SLAMonitoring      bool     `json:"slaMonitoring"`
        NetbootMode        string   `json:"netbootMode"`
        MemoryLimit        int      `json:"memoryLimit"`
        OfferType          string   `json:"offerType"`
        Vcore              int      `json:"vcore"`
}

const (
        vpsLabelPrefix = metaLabelPrefix + "vps_"
)

type vpsDiscovery struct {
        *refresh.Discovery
        config *SDConfig
        logger log.Logger
}

func newVpsDiscovery(conf *SDConfig, logger log.Logger) *vpsDiscovery <span class="cov8" title="1">{
        return &amp;vpsDiscovery{config: conf, logger: logger}
}</span>

func getVpsDetails(client *ovh.Client, vpsName string) (*Vps, error) <span class="cov8" title="1">{
        var vpsDetails Vps
        vpsNamePath := fmt.Sprintf("%s/%s", vpsAPIPath, vpsName)

        err := client.Get(vpsNamePath, &amp;vpsDetails)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">var ips []string
        err = client.Get(fmt.Sprintf("%s/ips", vpsNamePath), &amp;ips)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">for _, ip := range ips </span><span class="cov8" title="1">{
                netIP, err := netaddr.ParseIP(ip)
                if err == nil &amp;&amp; netIP.IsValid() &amp;&amp; !netIP.IsZero() </span><span class="cov8" title="1">{
                        if netIP.Is4() </span><span class="cov8" title="1">{
                                vpsDetails.IPV4 = ip
                        }</span> else<span class="cov8" title="1"> {
                                vpsDetails.IPV6 = ip
                        }</span>
                }
        }

        <span class="cov8" title="1">return &amp;vpsDetails, nil</span>
}

func getVpsList(client *ovh.Client) ([]string, error) <span class="cov8" title="1">{
        var vpsListName []string

        err := client.Get(vpsAPIPath, &amp;vpsListName)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return vpsListName, nil</span>
}

func (d *vpsDiscovery) getSource() string <span class="cov8" title="1">{
        return "ovhcloud_vps"
}</span>

func (d *vpsDiscovery) refresh(ctx context.Context) ([]*targetgroup.Group, error) <span class="cov8" title="1">{
        client, err := (d.config).CreateClient()
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">var vpsDetailedList []Vps
        vpsList, err := getVpsList(client)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">for _, vpsName := range vpsList </span><span class="cov8" title="1">{
                vpsDetailed, err := getVpsDetails(client, vpsName)
                if err != nil </span><span class="cov8" title="1">{
                        err := level.Warn(d.logger).Log("msg", fmt.Sprintf("%s: Could not get details of %s", d.getSource(), vpsName), "err", err.Error())
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov8" title="1">continue</span>
                }
                <span class="cov8" title="1">vpsDetailedList = append(vpsDetailedList, *vpsDetailed)</span>
        }

        <span class="cov8" title="1">var targets []model.LabelSet
        for _, server := range vpsDetailedList </span><span class="cov8" title="1">{
                labels := model.LabelSet{
                        model.AddressLabel:  model.LabelValue(server.IPV4),
                        model.InstanceLabel: model.LabelValue(server.Name),
                }

                fields := structs.Fields(server)
                addFieldsOnLabels(fields, labels, vpsLabelPrefix)

                modelFields := structs.Fields(server.Model)
                addFieldsOnLabels(modelFields, labels, vpsLabelPrefix)

                targets = append(targets, labels)
        }</span>

        <span class="cov8" title="1">return []*targetgroup.Group{{Source: d.getSource(), Targets: targets}}, nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
